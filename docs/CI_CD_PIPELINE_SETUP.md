# 云效流水线自动化测试配置指南

本文档说明如何在阿里云云效流水线中配置自动化测试。

## 目录

1. [测试类型说明](#测试类型说明)
2. [流水线配置建议](#流水线配置建议)
3. [测试步骤详细配置](#测试步骤详细配置)
4. [环境变量配置](#环境变量配置)
5. [最佳实践](#最佳实践)

## 测试类型说明

本项目包含两种类型的测试：

### 1. 单元测试 (Unit Tests)
- **文件模式**: `*_test.go` (排除 `*_it_test.go`)
- **特点**: 
  - 不依赖外部资源（如数据库）
  - 使用 mock 对象隔离依赖
  - 运行速度快
- **运行命令**: `go test -v -short ./...`

### 2. 集成测试 (Integration Tests)
- **文件模式**: `*_it_test.go`
- **特点**:
  - 需要真实的数据库连接
  - 测试完整的业务流程
  - 运行时间较长
- **运行命令**: `go test -v -timeout 10m -run "^Test.*Suite" ./...`

## 流水线配置建议

建议在**构建阶段**和**部署阶段**之间添加**测试阶段**，流程如下：

```
流水线源 → 构建 → [测试阶段] → 部署
```

### 测试阶段结构

```
测试阶段
├── 单元测试
│   ├── 运行单元测试
│   └── 生成覆盖率报告（可选）
├── 集成测试（可选）
│   ├── 准备测试数据库
│   └── 运行集成测试
└── 测试结果汇总
```

## 测试步骤详细配置

### 方案一：使用测试脚本（推荐）

#### 步骤 1: 单元测试

1. **步骤名称**: `运行单元测试`
2. **步骤类型**: `执行命令`
3. **工作目录**: 项目根目录
4. **执行命令**:
   ```bash
   chmod +x scripts/run_tests_simple.sh
   TEST_MODE=unit bash scripts/run_tests_simple.sh
   ```
5. **环境变量**（可选）:
   ```
   COVERAGE_THRESHOLD=50  # 覆盖率阈值（百分比）
   ```

#### 步骤 2: 集成测试（可选）

1. **步骤名称**: `运行集成测试`
2. **步骤类型**: `执行命令`
3. **工作目录**: 项目根目录
4. **前置条件**: 需要准备测试数据库
5. **执行命令**:
   ```bash
   chmod +x scripts/run_tests_simple.sh
   TEST_MODE=integration bash scripts/run_tests_simple.sh
   ```
6. **环境变量**:
   ```
   TEST_DB_DSN=root:password@tcp(mysql-host:3306)/test_db?charset=utf8mb4&parseTime=True&loc=Local
   ```

### 方案二：直接使用 Go 命令

#### 步骤 1: 单元测试

1. **步骤名称**: `Game服务单元测试`
2. **步骤类型**: `执行命令`
3. **工作目录**: `game`
4. **执行命令**:
   ```bash
   go test -v -short -race -coverprofile=coverage_game.out ./handler/...
   go tool cover -func=coverage_game.out
   ```

5. **步骤名称**: `CP Center服务单元测试`
6. **步骤类型**: `执行命令`
7. **工作目录**: `cp_center`
8. **执行命令**:
   ```bash
   go test -v -short -race -coverprofile=coverage_cp.out ./handler/...
   go tool cover -func=coverage_cp.out
   ```

#### 步骤 2: 集成测试

1. **步骤名称**: `Game服务集成测试`
2. **步骤类型**: `执行命令`
3. **工作目录**: `game`
4. **执行命令**:
   ```bash
   go test -v -timeout 10m -run "^Test.*Suite" ./handler/...
   ```

5. **步骤名称**: `CP Center服务集成测试`
6. **步骤类型**: `执行命令`
7. **工作目录**: `cp_center`
8. **执行命令**:
   ```bash
   go test -v -timeout 10m -run "^Test.*Suite" ./handler/...
   ```

## 环境变量配置

### 单元测试环境变量

| 变量名 | 说明 | 默认值 | 必需 |
|--------|------|--------|------|
| `TEST_MODE` | 测试模式：unit/integration/all | `unit` | 否 |
| `COVERAGE_THRESHOLD` | 覆盖率阈值（百分比） | `0` | 否 |

### 集成测试环境变量

| 变量名 | 说明 | 默认值 | 必需 |
|--------|------|--------|------|
| `TEST_DB_DSN` | 测试数据库连接字符串 | `root:admin123@tcp(127.0.0.1:3306)/game_launchpad_test?charset=utf8mb4&parseTime=True&loc=Local` | 是（推荐） |

**TEST_DB_DSN 格式**:
```
用户名:密码@tcp(主机:端口)/数据库名?charset=utf8mb4&parseTime=True&loc=Local
```

**在云效流水线中配置环境变量**:
1. 进入流水线配置页面
2. 找到"环境变量"配置项
3. 添加上述环境变量
4. 对于敏感信息（如数据库密码），建议使用云效的"变量组"功能进行加密存储

## 最佳实践

### 1. 测试执行策略

- **Pull Request 阶段**: 只运行单元测试（快速反馈）
- **Merge 到主分支**: 运行单元测试 + 集成测试（全面验证）
- **定时任务**: 可以运行完整的集成测试套件

### 2. 测试失败处理

- 如果单元测试失败，应该阻止部署
- 如果集成测试失败，可以配置为警告，不阻止部署（根据实际情况调整）

### 3. 测试覆盖率

- 建议设置覆盖率阈值（如 50% 或更高）
- 在流水线中生成覆盖率报告
- 可以考虑集成第三方工具（如 SonarQube）进行代码质量分析

### 4. 测试数据库管理

- 使用独立的测试数据库，不要使用生产数据库
- 每次测试前清理数据，确保测试环境干净
- 考虑使用 Docker 容器化的测试数据库，便于管理

### 5. 测试并行执行

- 单元测试可以并行运行多个服务的测试
- 集成测试由于需要数据库，建议串行执行

### 6. 测试结果报告

- 在流水线中配置测试结果收集
- 可以生成 JUnit XML 格式的测试报告（需要额外工具）
- 保存测试日志和覆盖率报告作为构建产物

## 云效流水线配置示例

### 完整测试阶段配置示例

```yaml
# 这是一个概念性的配置示例，实际配置在云效界面完成
测试阶段:
  - 步骤名称: "运行单元测试"
    步骤类型: "执行命令"
    工作目录: "${WORKSPACE}"
    执行命令: |
      chmod +x scripts/run_tests_simple.sh
      TEST_MODE=unit bash scripts/run_tests_simple.sh
    失败策略: "失败时停止"
    
  - 步骤名称: "准备测试数据库"
    步骤类型: "执行命令"
    执行命令: |
      # 这里可以添加数据库初始化脚本
      # 例如：创建测试数据库、运行迁移等
    失败策略: "失败时停止"
    
  - 步骤名称: "运行集成测试"
    步骤类型: "执行命令"
    工作目录: "${WORKSPACE}"
    环境变量:
      TEST_DB_DSN: "${TEST_DB_DSN}"
    执行命令: |
      chmod +x scripts/run_tests_simple.sh
      TEST_MODE=integration bash scripts/run_tests_simple.sh
    失败策略: "失败时警告"  # 根据实际情况调整
```

## 常见问题

### Q1: 集成测试需要真实的数据库吗？

A: 是的，集成测试需要连接到真实的 MySQL 数据库。建议在云效中配置一个专门的测试数据库。

### Q2: 如何跳过集成测试？

A: 设置环境变量 `TEST_MODE=unit`，或者不在流水线中配置集成测试步骤。

### Q3: 测试失败时如何调试？

A: 
1. 查看测试日志输出
2. 检查数据库连接是否正常
3. 确认环境变量是否正确设置
4. 可以在本地运行相同的测试命令进行调试

### Q4: 如何提高测试速度？

A:
- 单元测试和集成测试分开执行
- 使用并行测试（`-parallel` 参数）
- 优化测试数据库的连接和清理逻辑
- 考虑使用测试数据库的快照功能

## 下一步

1. 在云效流水线中添加测试阶段
2. 配置环境变量
3. 运行一次完整的流水线，验证测试步骤
4. 根据实际需求调整测试策略和失败处理方式

