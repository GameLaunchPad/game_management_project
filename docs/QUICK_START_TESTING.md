# 云效流水线自动化测试快速开始

## 3分钟快速配置

### 第一步：添加测试步骤

在云效流水线中，在**构建**和**部署**之间添加一个新的**测试阶段**。

### 第二步：配置单元测试

**重要**：确保测试步骤在 Go 环境安装之后执行！

1. 在测试阶段中添加一个**执行命令**步骤
2. 步骤名称：`Game服务单元测试`
3. 工作目录：`${WORKSPACE}` 或留空（使用项目根目录）
4. **执行命令**：
   ```bash
   chmod +x scripts/run_tests_simple.sh
   bash scripts/run_tests_simple.sh
   ```
5. **环境变量**（可选，设置覆盖率阈值）：
   ```
   COVERAGE_THRESHOLD=50
   ```
   > 说明：如果设置了 `COVERAGE_THRESHOLD`，测试会检查覆盖率是否达到阈值，未达到会失败。
6. 失败策略：**失败时停止**（测试失败时阻止部署）

**注意**：如果遇到 `go: command not found` 错误：
- 确保测试步骤在"安装go"步骤之后执行
- 如果测试步骤是独立的环境，需要单独添加"安装go"步骤
- 或者确保测试步骤与构建步骤使用相同的运行环境

### 第三步：保存并运行

保存流水线配置，然后触发一次构建，验证测试步骤是否正常工作。

## 功能说明

### 当前测试配置

- ✅ **只测试 game 服务的 handler 目录**（不测试其他目录如 dao, dal, service 等）
- ✅ **只运行单元测试**（不运行集成测试）
- ✅ **只统计 handler 目录下代码的覆盖率**（不包括测试文件和其他目录）
- ✅ **自动生成代码覆盖率报告**
- ✅ **支持覆盖率阈值检查**（可选）
- ✅ **生成 HTML 覆盖率报告**
- ✅ **生成 JSONL 格式的测试报告**（用于云效测试报告）
- ✅ **生成 JSON 格式的覆盖率报告**（用于云效显示覆盖率）
- ✅ **覆盖率信息自动添加到测试报告中**

## 环境变量配置

### 可选的环境变量

- `COVERAGE_THRESHOLD`: 覆盖率阈值（百分比）
  - 默认值：`95`（要求覆盖率至少 95%）
  - 示例：`50` 表示要求覆盖率至少 50%
  - 如果覆盖率低于阈值，测试会失败
  - 测试失败时会显示未覆盖的代码分析

## 常见问题

### Q: 测试会运行哪些内容？

A: 
- ✅ 只运行 `game/handler` 目录下的单元测试
- ✅ 排除集成测试文件（`*_it_test.go`）
- ✅ 不测试其他目录（dao, dal, service 等）
- ✅ 不测试 `cp_center` 和 `game_platform_api` 服务

### Q: 如何设置覆盖率要求？

A: 在流水线步骤的环境变量中设置 `COVERAGE_THRESHOLD`，例如：
```
COVERAGE_THRESHOLD=50
```
这表示要求代码覆盖率至少达到 50%，否则测试会失败。

### Q: 测试失败怎么办？

A: 
1. 查看流水线日志，找到失败的具体测试用例
2. 如果是覆盖率检查失败，查看覆盖率报告，了解哪些代码没有被测试覆盖
3. 检查环境变量是否正确配置
4. 可以在本地运行相同的命令进行调试：
   ```bash
   cd game
   go test -v -short -race -coverprofile=coverage.out ./...
   go tool cover -func=coverage.out
   ```

### Q: 如何查看详细的覆盖率报告？

A: 
1. 脚本会在控制台输出覆盖率报告（只显示 handler 目录的覆盖率）
2. 脚本会自动生成 HTML 报告：`game/handler_coverage.html`
3. 可以在流水线构建产物中下载查看
4. 覆盖率报告只统计 handler 目录下的非测试代码（`*.go` 文件，不包括 `*_test.go`）

### Q: 什么是 JSONL 测试报告？如何在云效中使用？

A: 
1. **JSONL 格式**：JSONL（JSON Lines）是一种文本格式，每行包含一个 JSON 对象
2. **自动生成**：脚本会自动生成 `game/test_report.jsonl` 文件
3. **在云效中使用**：
   - 在云效流水线的测试步骤配置中，找到"测试报告"配置项
   - 将测试报告文件路径设置为：`game/test_report.jsonl`
   - 云效会自动解析 JSONL 文件，在测试报告页面显示测试结果
4. **文件位置**：JSONL 文件会生成在 `game/test_report.jsonl`
5. **格式说明**：每行是一个 JSON 对象，包含测试事件信息（测试开始、通过、失败等）
6. **覆盖率信息**：JSONL 文件中已包含覆盖率信息（Action="coverage" 的行），云效可以直接读取显示

### Q: 如何在云效中显示测试覆盖率？

A: 
1. **自动方式**：覆盖率信息已自动添加到JSONL测试报告中，云效会自动解析并显示
2. **JSON文件方式**：
   - 脚本会生成 `game/coverage_report.json` 文件
   - 在云效流水线配置中，找到"覆盖率报告"或"测试覆盖率"配置项
   - 将覆盖率报告文件路径设置为：`game/coverage_report.json`
3. **查看HTML报告**：
   - 下载 `game/handler_coverage.html` 文件
   - 在浏览器中打开，查看可视化的覆盖率报告
4. **覆盖率报告包含**：
   - 总覆盖率百分比
   - 覆盖率阈值
   - 每个函数的详细覆盖率
   - 时间戳信息

### Q: 可以同时测试多个服务吗？

A: 当前脚本只测试 `game` 服务。如果需要测试其他服务，可以使用 `run_tests.sh` 脚本。

### Q: 为什么测试执行速度这么快（接近0s）？

A: 这是正常的，单元测试速度快是优点，原因：
1. **使用了 Mock**：没有真实的数据库操作，避免了 I/O 延迟
2. **逻辑简单**：Handler 层主要是参数校验和调用 DAO，逻辑相对简单
3. **测试隔离良好**：每个测试独立运行，没有外部依赖
4. **最佳实践**：快速反馈是单元测试的核心优势

如果测试执行时间过长，反而说明测试设计有问题（可能使用了真实数据库或网络请求）。

### Q: 如何提升测试覆盖率？

A: 
1. **查看测试用例改进指南**（推荐）：
   ```bash
   # 查看详细的测试用例改进指南
   cat docs/TEST_CASE_IMPROVEMENT_GUIDE.md
   ```
   该指南包含所有缺失的测试用例和完整代码示例

2. **运行覆盖率分析**：
   ```bash
   # 查看HTML覆盖率报告（已包含总覆盖率信息）
   open game/handler_coverage.html
   ```

3. **查看HTML报告**：打开 `game/handler_coverage.html` 查看未覆盖的代码行

4. **添加测试用例**：
   - 参考 `docs/TEST_CASE_IMPROVEMENT_GUIDE.md` 中的代码示例
   - 从高优先级开始添加
   - 每次添加后运行测试，查看覆盖率变化

5. **查看详细指南**：参考 `docs/COVERAGE_IMPROVEMENT.md`

### Q: 遇到 "go: command not found" 错误怎么办？

A: 这表示测试步骤中找不到 Go 命令。解决方法：

1. **确保 Go 已安装**：在测试步骤之前添加"安装go"步骤
   - 如果构建步骤中有"安装go"，确保测试步骤在构建步骤之后
   - 或者测试步骤中单独添加"安装go"

2. **检查运行环境**：
   - 确保测试步骤与构建步骤使用相同的运行环境
   - 或者测试步骤使用独立环境时，需要单独安装 Go

3. **云效流水线配置建议**：
   ```
   构建阶段
   ├── 申请运行环境
   ├── 克隆代码
   ├── 安装go ← 确保这一步存在
   └── ... 其他构建步骤
   
   测试阶段
   ├── Game服务单元测试 ← 确保在安装go之后
   └── ...
   ```

4. **脚本会自动尝试修复**：
   - 脚本会尝试查找常见的 Go 安装路径
   - 如果找到，会自动添加到 PATH 环境变量

## 下一步

- 查看详细配置文档：[CI_CD_PIPELINE_SETUP.md](./CI_CD_PIPELINE_SETUP.md)
- 查看脚本说明：[../scripts/README.md](../scripts/README.md)

